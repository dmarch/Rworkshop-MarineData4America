---
title: "Rstudio demo"
author: "David March"
date: '2021-06-30'
output:
  pdf_document: default
  html_notebook: default
  word_document: default
subtitle: Using R to work with Copernicus Marine Data
urlcolor: blue
---

# Introduction

This tutorial is aimed to provide you an introductory overview on using R programming language to work with [CMEMS](https://marine.copernicus.eu/) data. R has a great potential to handle marine spatial data and perform complex spatial operations. In particular, we will use [RStudio](https://www.rstudio.com/), a popular Integrated Development Environment (IDE) for coding in R.


# Setup

In order to follow this tutorial, you will need to:

1. Install [RStudio Desktop](https://www.rstudio.com/). The Open Source Edition provides a free license for multiple operating systems.

2. Download the sample data from [here](https://www.rstudio.com/).

3. Open Rstudio and run the following code to install all required packages:

```{r message = FALSE, warning = FALSE, eval = FALSE}
install.packages(c("raster", "ncdf4", "ggplot2", "lubridate", "sf", "leaflet"))
```

# NetCDF files

[NetCDF](https://www.unidata.ucar.edu/software/netcdf/) is a community standard for sharing scientific data. It has been adopted as a data format for many oceanography systems, including the Copernicus Marine products. A NetCDF file contains dimensions, variables, and attributes.

* **Dimensions** represent real physical dimension (e.g. time, longitude, latitude).

* **Variables** are used to represent values of the same type (e.g. water temperature) and are described by its list of dimensions.

* **Attributes** are use to keep information about the data. They can provide information about one specific variable (e.g. units) or about the whole dataset (e.g. processing details)



# Inspect NetCDF files

Here we will import and explore a NetCDF file from R. The NetCDF correspond to a sample file from a numerical model from CMEMS. More specifically, it corresponds to a sea water temperature datasets from the Global Ocean 1/12ยบ Physics Analysis and Forecast. In the following table, you can check the parameters used to download the dataset.

| Parameter        | Value         |
|:---------------- |:--------------| 
| Longitude (min)  | -120          |
| Longitude (max)  | -20           |
| Latitude (min)   | -20           |
| Latitude (max)   | 40            |
| Start depth      | 1.5414        |
| End depth        | 1.5414        |
| Variables        | thetao        |
| Start time       | 2021-05-01 12:00 |
| End time         | 2021-05-31 12:00 |

Table: Parameters of the sample dataset. Downloaded from Global Ocean 1/12ยบ Physics Analysis and Forecast (Product: GLOBAL-ANALYSIS-FORECAST-PHY-001-024)



In order to inspect the NetCDF, we will use the `ncdf4` package. This package provides a R interface to NetCDF files and allow reading and editing them.



```{r message = FALSE, warning = FALSE}
library(ncdf4)

# Import NetCDF
nc <- nc_open("data/global-analysis-forecast-phy-001-024_1623968610655.nc")

# Prints information about the NetCDF file, including the variables and dimensions it contains.
print(nc)
```


We can see that the NetCDF contains **1** variable, **4** dimensions and **25** global attributes.

The variable `thetao` contains specific attributes, including the names, units and complementary parameters. You can check the documentation of the product for further details.

**Note:** Time in NetCDF can be coded                                    following different conventions. Therefore,                                   it is very important to inpect the NetCDF and check the format used. In this case, as you can see from the print, the unit of the time dimension is: hours since 1950-01-01 00:00:00. Note that some products format their data using different reference dates and/or using seconds/days rather than hours. Such variability is also present in CMEMS.

```{r message = FALSE, warning = FALSE}
# Print units for time dimension
nc$dim$time$units
```

We will get back to this point when handling multiple dates.


# Import NetCDF as Raster

The numerical model can be considerer as a gridded product. To manipulate and visualize gridded data, we will use the `raster` package.

```{r message = FALSE, warning = FALSE} 
library(raster)

# import NetCDF with raster
sst <- raster("data/global-analysis-forecast-phy-001-024_1623968610655.nc")

# plot raster dataset
plot(sst)

# print a summary of the raster
sst
```

Exploring the summary, we got that there only one band (out of 31). In addition, we can see information on the spatial and temporal resolutions.

**Note:** The function `raster()` only work for single layers. If you want to work with multiple bands, consider using `brick()` or `stack()`.


## Multiband layers

```{r message = FALSE, warning = FALSE} 
library(raster)

# import NetCDF with raster
sst <- brick("data/global-analysis-forecast-phy-001-024_1623968610655.nc")

# plot raster dataset
plot(sst)

# print a summary of the raster
sst
```




## Extract data from a marine protected area

UNEP-WCMC and IUCN (2021), Protected Planet: The World Database on Protected Areas (WDPA) and World Database on Other Effective Area-based Conservation Measures (WD-OECM) [Online], June 2021, Cambridge, UK: UNEP-WCMC and IUCN. Available at: www.protectedplanet.net.


```{r message = FALSE, warning = FALSE} 
library(sf)
library(leaflet)

# Import boundaries of Galapagos Islands Marine Protected Area
mpa <- st_read("data/GalapagosMPA.gpkg")

# Plot the boundary of MPA with a base map
leaflet(mpa) %>% 
  addProviderTiles("Esri.OceanBasemap") %>% 
  addPolygons(color = "green")
```


## Zona statistics

Here we will summarize raster values over polygonal areas, commonly referred to as zonal statistics. We will use the `exactextractr` package, which is suited to work with big datasets. In addition, unlike most zonal statistics implementations, it handles grid cells that are partially covered by a polygon. For further information about this package, check out its latest developments [here](https://github.com/isciences/exactextractr).





https://resources.marine.copernicus.eu/?option=com_csw&view=details&product_id=SST_GLO_SST_L4_REP_OBSERVATIONS_010_011

```{r message = FALSE, warning = FALSE} 
library(raster)

# import NetCDF with raster
sst <- brick("data/global-reanalysis-phy-001-030-monthly_1623978556148.nc")

# plot raster dataset
plot(sst)

# print a summary of the raster
sst
```



https://dominicroye.github.io/en/2018/how-to-create-warming-stripes-in-r/


```{r message = FALSE, warning = FALSE} 
library(exactextractr)
library(lubridate)

# get date
date_sst <- getZ(sst) %>% parse_date_time("Ymd HMS")

# calculate average SST
avg_sst <- exact_extract(sst, mpa, 'mean', stack_apply=T, force_df = F)
avg_sst <- data.table::transpose(avg_sst)
avg_sst <- data.frame(date = date_sst, sst = avg_sst)

plot(avg_sst$date, avg_sst$V1, type="l")

```








## Make a plot (map and time series)






