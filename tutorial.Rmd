---
title: "Rstudio demo"
author: "David March"
date: '2021-06-30'
output:
  pdf_document:
  html_notebook:
    toc: yes
subtitle: Using R to work with Copernicus Marine Data
urlcolor: blue
toc-title: "Table of contents"
---

# Introduction

This tutorial is aimed to provide you an introductory overview on using R programming language to work with [CMEMS](https://marine.copernicus.eu/) data. R has a great potential to handle marine spatial data and perform complex spatial operations. In particular, we will use [RStudio](https://www.rstudio.com/), a popular Integrated Development Environment (IDE) for coding in R.

Here, you will learn how to use RStudio to:

* Import and inspect NetCDF files

* Visualize and analyze gridded products

* Explore spatial data with dynamic maps

* Analyze gridded products

* Extract data from vector data

* Plot maps and temporal series


# Setup

## Install RStudio

In order to follow this tutorial, you will need to:

1. Install [RStudio Desktop](https://www.rstudio.com/). The Open Source Edition provides a free license for multiple operating systems.

2. Open Rstudio and run the following code to install all required packages:

```{r message = FALSE, warning = FALSE, eval = FALSE}
install.packages(c("raster", "ncdf4", "ggplot2", "lubridate", "sf", "leaflet",
                   "rasterVis", "rnaturalearth", "rnaturalearthdata"))
```


3. Start loading the required packages
```{r message = FALSE, warning = FALSE}
library(ncdf4)
library(raster)
library(sf)
library(leaflet)
library(lubridate)
library(rasterVis)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
```


## Download code and sample data

Download the sample data from [here](https://www.rstudio.com/).





# NetCDF files in R

### Introduction to the NetCDF format

[NetCDF](https://www.unidata.ucar.edu/software/netcdf/) is a community standard for sharing scientific data. It is particularly well suited to represent multidensional data, and has been adopted as a data format for many oceanography systems, including the Copernicus Marine products. A NetCDF file contains dimensions, variables, and attributes.

* **Dimensions** represent real physical dimension (e.g. time, longitude, latitude).

* **Variables** are used to represent values of the same type (e.g. water temperature) and are described by its list of dimensions.

* **Attributes** are used to keep information about the data. They can provide information about one specific variable (e.g. units) or about the whole dataset (e.g. processing details)



### Inspect NetCDF files in R

Here we will import and explore a NetCDF file from R. The NetCDF correspond to a sample file from a numerical model from CMEMS. More specifically, it corresponds to a sea water temperature datasets from the Global Ocean 1/12º Physics Analysis and Forecast. In the following table, you can check the parameters used to download the dataset.

| Parameter        | Value         |
|:---------------- |:--------------| 
| Longitude (min)  | -120          |
| Longitude (max)  | -20           |
| Latitude (min)   | -20           |
| Latitude (max)   | 40            |
| Start depth      | 0.494        |
| End depth        | 0.494        |
| Variables        | thetao        |
| Start time       | 2020-01-16 12:00 |
| End time         | 2020-12-16 12:00 |

Table: Parameters of the sample dataset. Downloaded from Global Ocean 1/12º Physics Analysis and Forecast (Product: GLOBAL-ANALYSIS-FORECAST-PHY-001-024-MONTHLY)


***Note:*** CMEMS products can be automatically downloaded from R using the [RCMEMS](https://github.com/markpayneatwork/RCMEMS) package. However, this approach requires the installation of Python and Motu client, and is beyond the scope of this tutorial.



In order to inspect the NetCDF, we will use the `ncdf4` package. This package provides a R interface to NetCDF files and allow reading and editing them.



```{r message = FALSE, warning = FALSE}
# Set the path for the sample NetCDF file
ncfile <- "data/global-analysis-forecast-phy-001-024-monthly_1624214790015.nc"

# Import NetCDF
nc <- nc_open(ncfile)

# Prints information about the NetCDF file, including the variables and dimensions it contains.
print(nc)
```


We can see that the NetCDF contains **1** variable, **4** dimensions and **18** global attributes.

The variable `thetao` contains specific attributes, including the names, units and complementary parameters. You can check the documentation of the product for further details.

**Note:** Time in NetCDF can be coded following different conventions. Therefore, it is very important to inspect the NetCDF and check the format used. In this case, as you can see from the print, the unit of the time dimension is: hours since 1950-01-01. Note that some products format their data using different reference dates and/or using seconds/days rather than hours. Such variability is also present in CMEMS.

```{r message = FALSE, warning = FALSE}
# Print units for time dimension
nc$dim$time$units
```

We will get back to this point when handling multiple dates.


# Import NetCDF as Raster

The numerical model can be considerer as a gridded product. To manipulate and visualize gridded data, we will use the `raster` package.

```{r message = FALSE, warning = FALSE} 
# import NetCDF with raster
sst_single <- raster(ncfile)

# print a summary of the raster
sst_single
```

The summary provides relevant information to understand the imported dataset, including the number of bands, spatial resolution, spatial extent, coordinate reference system (CRS), name of variable, time stamps.




## Basic maps

The ***raster*** package provides a `plot()` function to visualize gridded products.

```{r message = FALSE, warning = FALSE} 
# plot raster dataset
plot(sst_single)

```

There are more advanced advances to plot raster data in R, using packages such as ***rasterVis*** or ***ggplot2***. In addition, packages such as ***leaflet*** offer the possibility to build interactive maps.




## Multiband layers

The function `raster()` only work for single band layers. In order to work with multiple bands, we can use `brick()` or `stack()` functions.

```{r message = FALSE, warning = FALSE} 
# import NetCDF with raster
sst_multi <- brick(ncfile)

# print a summary of the raster
sst_multi

# plot raster dataset
levelplot(sst_multi)
```


We now can see that all bands from the NetCDF file (each one for a different time stamp) have been imported.



## Raster operations




```{r message = FALSE, warning = FALSE} 

# calculate average and SD
sst_mean <- calc(sst_multi, fun = mean)
sst_sd <- calc(sst_multi, fun = sd)

# plot raster dataset
plot(sst_mean, main = "Average SST")
plot(sst_sd, main = "Standard deviation SST")
```



## Maps with ggplot2


```{r message = FALSE, warning = FALSE} 
# convert raster to data.frame
sst_df <- as.data.frame(sst_mean, xy=TRUE, na.rm=TRUE)

# import countries layer from Natural Earth
countries <- ne_countries(scale = "medium", returnclass = "sf")

# plot
ggplot()+
  # add raster layer
  geom_raster(aes(x=x, y=y, fill=layer), data=sst_df) +
  # define color palette of raster layer
  scale_fill_distiller(palette = "Spectral", name = "SST (ºC)") + 
  # add countries layers
  geom_sf(fill=grey(0.9), color=grey(0.6), lwd = 0.2, data=countries) +
  # define spatial extent
  coord_sf(xlim = range(sst_df$x), ylim = range(sst_df$y), expand = c(0,0)) +
  # labels
  labs(title = "Sea Surface Temperature (SST)",
       subtitle = "Annual average estimated from monthly products for 2020",
       x = "Longitude",
       y = "Latitude") +
  # theme
  theme_bw() 
```







## Extract values from a Raster object

Raster values can be sampled from any type of vector data (i.e. points, lines, polygons). In the marine realm, such type of vector data can be used to represent different objects:

* ***Points:*** Points can represent sampling locations, static platforms such as oceanographic buoys or moving objects such as animal tracks.

* ***Lines:*** Lines can be used to represent survey transects, shoreline, cables, pipelines.

* ***Polygons:*** This geometry can be used to represent marine boundaries, such as marine protected areas (MPAs) or jurisdictional waters.

The function `extract()` offers a common approach to sample raster values from any of these types of vector data. In the following example, we will use the boundaries of the Galapagos Islands marine protected area. This boundary has been acquired from the [World Database on Protected Areas](www.protectedplanet.net).




```{r message = FALSE, warning = FALSE} 
# Import boundaries of Galapagos Islands Marine Protected Area
mpa <- st_read("data/GalapagosMPA.gpkg")


#palRaster <- colorNumeric("Spectral", domain = sst_mean@data@values, reverse = TRUE)

# Plot the boundary of MPA with a base map
leaflet(mpa) %>% 
  addProviderTiles("Esri.OceanBasemap") %>%
  #addRasterImage(sst_mean, colors = palRaster, opacity = 0.8) %>%
  #addLegend(pal = palRaster, values = values(sst_mean), title = "SST (ºC)") %>%
  addPolygons(color = "green")
```


## Zona statistics

Here we will summarize raster values over polygonal areas, commonly referred to as zonal statistics. We will use the ***exactextractr*** package, which is suited to work with big datasets. In addition, unlike most zonal statistics implementations, it handles grid cells that are partially covered by a polygon. For further information about this package, check out its latest developments [here](https://github.com/isciences/exactextractr).





https://resources.marine.copernicus.eu/?option=com_csw&view=details&product_id=SST_GLO_SST_L4_REP_OBSERVATIONS_010_011

```{r message = FALSE, warning = FALSE} 
# import NetCDF with raster
# sst <- brick("data/global-reanalysis-phy-001-030-monthly_1623978556148.nc")
# 
# # plot raster dataset
# plot(sst)
# 
# # print a summary of the raster
# sst
```



```{r message = FALSE, warning = FALSE} 
# get date
date_sst <- sst_multi %>%
  # get time stamps from multi raster
  getZ() %>%
  # parse character to POSIXct class (time)
  parse_date_time("Ymd HMS") %>%
  # get the first day of each month
  floor_date("month")

# extract values from MPA and summarize values using the mean and standard deviation
mpa_sst_avg <- raster::extract(sst_multi, mpa, fun=mean, na.rm=T)
mpa_sst_sd <- raster::extract(sst_multi, mpa, fun=sd, na.rm=T)

# generate data.frame with three new columns (time, mean, sd)
mpa_sst <- data.frame(date = date_sst, sst_avg = c(mpa_sst_avg), sst_sd = c(mpa_sst_sd))

# inspect data.frame
mpa_sst
```


Plot time series. You can find further information about the ***ggplot2*** package [here](https://ggplot2.tidyverse.org/)

```{r message = FALSE, warning = FALSE} 
# plot data
ggplot(mpa_sst, aes(x = date)) +
  # add ribbon to represent mean +- SD
  geom_ribbon(aes(ymin = sst_avg-sst_sd, ymax = sst_avg+sst_sd),  alpha=.2, linetype=0, fill="steelblue") +
  # add line to represent mean value
  geom_line(aes(y = sst_avg), size = 1, color="steelblue") +
  # define frequency of x-axis and date labels
  scale_x_datetime(date_breaks = "1 month", date_labels = "%b") +
  # plot labels labels
  labs(title = "Sea Surface Temperature (SST) in Galapagos Islands MPA",
       # note we use `expression()` to add +- symbol
       subtitle = expression(Monthly~values~(mean %+-% SD)~from~2020),
       x = "",
       y = "SST (ºC)") +
  # theme
  theme_bw() 

```





